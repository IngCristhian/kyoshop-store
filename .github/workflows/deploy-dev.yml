name: Deploy to Development

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Development Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          cd ${{ secrets.DEPLOY_PATH_DEV }}

          # Check if git repo exists, if not clone it
          if [ ! -d ".git" ]; then
            echo "üÜï First deployment - cloning repository..."
            git clone -b develop https://github.com/IngCristhian/kyoshop-store.git /tmp/kyoshop-store-temp
            cp -r /tmp/kyoshop-store-temp/* .
            cp /tmp/kyoshop-store-temp/.??* . 2>/dev/null || true
            rm -rf /tmp/kyoshop-store-temp
            echo "‚úÖ Repository cloned successfully"
          else
            echo "üîÑ Existing repository - pulling latest changes..."
            git pull origin develop
          fi

          # Update .htaccess with development environment variables
          sed -i 's/SetEnv DB_NAME ".*"/SetEnv DB_NAME "${{ secrets.DB_NAME_DEV }}"/' .htaccess
          sed -i 's/SetEnv DB_USER ".*"/SetEnv DB_USER "${{ secrets.DB_USER_DEV }}"/' .htaccess
          sed -i 's/SetEnv DB_PASSWORD ".*"/SetEnv DB_PASSWORD "${{ secrets.DB_PASSWORD_DEV }}"/' .htaccess
          sed -i 's/SetEnv APP_URL ".*"/SetEnv APP_URL "https:\/\/dev.kyoshop.co"/' .htaccess
          sed -i 's/SetEnv ADMIN_URL ".*"/SetEnv ADMIN_URL "https:\/\/dev.inventory.kyoshop.co"/' .htaccess
          sed -i 's/SetEnv WHATSAPP_NUMBER ".*"/SetEnv WHATSAPP_NUMBER "${{ secrets.WHATSAPP_NUMBER }}"/' .htaccess
          sed -i 's/SetEnv EPAYCO_PUBLIC_KEY ".*"/SetEnv EPAYCO_PUBLIC_KEY "${{ secrets.EPAYCO_PUBLIC_KEY_TEST }}"/' .htaccess
          sed -i 's/SetEnv EPAYCO_PRIVATE_KEY ".*"/SetEnv EPAYCO_PRIVATE_KEY "${{ secrets.EPAYCO_PRIVATE_KEY_TEST }}"/' .htaccess
          sed -i 's/SetEnv EPAYCO_TEST_MODE ".*"/SetEnv EPAYCO_TEST_MODE "true"/' .htaccess

          # Set proper file permissions
          chmod 644 config/*.php
          chmod 644 .htaccess

          # Create symlink to inventory uploads (for faster image loading)
          echo "üîó Creating symlink to inventory uploads..."
          rm -rf uploads
          ln -sf ~/dev.inventory.kyoshop.co/uploads uploads
          ls -la uploads

          # Clear cache if exists
          rm -rf cache/*

          echo "‚úÖ Development deployment completed successfully"
          echo "üåê Available at: https://dev.kyoshop.co"
