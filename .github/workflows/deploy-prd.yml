name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          cd ${{ secrets.DEPLOY_PATH_PRD }}

          # Check if git repo exists, if not clone it
          if [ ! -d ".git" ]; then
            echo "üÜï First deployment - cloning repository..."
            git clone -b main https://github.com/IngCristhian/kyoshop-store.git /tmp/kyoshop-store-temp
            cp -r /tmp/kyoshop-store-temp/* .
            cp /tmp/kyoshop-store-temp/.??* . 2>/dev/null || true
            rm -rf /tmp/kyoshop-store-temp
            echo "‚úÖ Repository cloned successfully"
          else
            echo "üîÑ Existing repository - pulling latest changes..."
            git pull origin main
          fi

          # Update .htaccess with production environment variables
          sed -i 's/SetEnv DB_NAME ".*"/SetEnv DB_NAME "${{ secrets.DB_NAME }}"/' .htaccess
          sed -i 's/SetEnv DB_USER ".*"/SetEnv DB_USER "${{ secrets.DB_USER_STORE }}"/' .htaccess
          sed -i 's/SetEnv DB_PASSWORD ".*"/SetEnv DB_PASSWORD "${{ secrets.DB_PASSWORD_STORE }}"/' .htaccess
          sed -i 's/SetEnv APP_URL ".*"/SetEnv APP_URL "https:\/\/kyoshop.co"/' .htaccess
          sed -i 's/SetEnv WHATSAPP_NUMBER ".*"/SetEnv WHATSAPP_NUMBER "${{ secrets.WHATSAPP_NUMBER }}"/' .htaccess
          sed -i 's/SetEnv EPAYCO_PUBLIC_KEY ".*"/SetEnv EPAYCO_PUBLIC_KEY "${{ secrets.EPAYCO_PUBLIC_KEY }}"/' .htaccess
          sed -i 's/SetEnv EPAYCO_PRIVATE_KEY ".*"/SetEnv EPAYCO_PRIVATE_KEY "${{ secrets.EPAYCO_PRIVATE_KEY }}"/' .htaccess
          sed -i 's/SetEnv EPAYCO_TEST_MODE ".*"/SetEnv EPAYCO_TEST_MODE "false"/' .htaccess

          # Set proper file permissions
          chmod 755 uploads/
          chmod 644 config/*.php
          chmod 644 .htaccess

          # Clear cache if exists
          rm -rf cache/*

          echo "‚úÖ Production deployment completed successfully"
          echo "üåê Available at: https://kyoshop.co"
